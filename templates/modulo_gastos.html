{% extends 'base.html' %}

{% block content %}
<style>
    /* Est√©tica Unificada y Profesional para San Roque M.B. */
    :root {
        --btn-size: 38px;
        --san-roque-dark: #1e293b;
        --san-roque-emerald: #10b981;
        --san-roque-sapphire: #3b82f6;
        --san-roque-ruby: #ef4444;
        --bg-main: #f8fafc;
    }

    body {
        background-color: var(--bg-main);
    }

    /* Botones de Acci√≥n Ultra-Profesionales con Tooltips */
    .btn-action-pro {
        width: auto(--btn-size);
        height: var(--btn-size);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px; 
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        padding: 0 15px;
        font-size: 1.1rem;
        background: #ffffff;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
        text-decoration: none !important;
    }

    .btn-action-pro:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }

    /* Tooltip personalizado */
    .btn-action-pro::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%) translateY(10px);
        background: var(--san-roque-dark);
        color: white;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 0.7rem;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 100;
    }

    .btn-action-pro:hover::after {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
    }

    /* Variantes de botones con colores vibrantes */
    .btn-abonar-prof { border: 1px solid #d1fae5; color: var(--san-roque-emerald); }
    .btn-abonar-prof:hover { background: var(--san-roque-emerald); color: white; }

    .btn-edit-prof { border: 1px solid #dbeafe; color: var(--san-roque-sapphire); }
    .btn-edit-prof:hover { background: var(--san-roque-sapphire); color: white; }

    .btn-delete-prof { border: 1px solid #fee2e2; color: var(--san-roque-ruby); }
    .btn-delete-prof:hover { background: var(--san-roque-ruby); color: white; }

    /* Cards y Tabla */
    .card-luxury {
        border-radius: 16px;
        border: 1px solid rgba(0,0,0,0.05);
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        background: #ffffff;
    }

    .text-negro-pro {
        color: #0f172a !important;
        font-weight: 700;
    }

    .table thead th {
        background: #f1f5f9;
        color: #64748b;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        border: none;
        padding: 15px;
    }

    .table tbody td {
        padding: 18px 15px;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Badge de Estado */
    .badge-status {
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .bg-pagado { background: #dcfce7; color: #15803d; }
    .text-saldo-pendiente { color: var(--san-roque-ruby); font-weight: 700; }

    .shadow-inner-soft {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
    }
</style>

<div class="container-fluid mt-4 px-4" style="position: relative; z-index: 1;">
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="p-4 card-luxury d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-negro-pro mb-1">üìâ Gesti√≥n de Gastos y Egresos</h2>
                    <p class="text-muted mb-0">Control financiero y seguimiento ‚Äî <strong>San Roque M.B.</strong></p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('ventas.dashboard') }}" class="btn btn-light fw-bold border px-4 rounded-3">Dashboard</a>
                    <a href="{{ url_for('proveedores_gastos.exportar_proveedores') }}" class="btn btn-dark fw-bold px-4 rounded-3 shadow-sm">Exportar Reporte</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card card-luxury p-4 h-100">
                <h5 class="mb-4 text-negro-pro d-flex align-items-center">
                    <span class="me-2 text-primary">‚óè</span> Nuevo Gasto Operativo
                </h5>

                <form method="POST" action="{{ url_for('proveedores_gastos.gastos') }}">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">CATEGOR√çA</label>
                        <select name="categoria" class="form-select border-0 bg-light p-3 rounded-3" required>
                            <option value="">Seleccionar...</option>
                            <option>Arriendo</option>
                            <option>Servicios P√∫blicos</option>
                            <option>Mantenimiento</option>
                            <option>N√≥mina / Personal</option>
                            <option>Insumos Bodega</option>
                            <option>Otros</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted">CONCEPTO DETALLADO</label>
                        <input type="text" name="concepto" class="form-control border-0 bg-light p-3 rounded-3" placeholder="Ej: Pago de Luz Enero" required>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">VALOR TOTAL ($)</label>
                            <input type="number" step="0.01" name="total" class="form-control border-0 bg-light p-3 rounded-3" placeholder="0.00" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">FECHA</label>
                            <input type="date" name="fecha" class="form-control border-0 bg-light p-3 rounded-3" value="{{ hoy }}">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 fw-bold py-3 rounded-3 shadow-sm">
                        <i class="bi bi-save me-2"></i>REGISTRAR EGRESO
                    </button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card card-luxury overflow-hidden">
                <div class="p-4 bg-white border-bottom">
                    <h5 class="m-0 text-negro-pro">üìã Historial de Movimientos</h5>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Fecha</th>
                                <th>Concepto / Categor√≠a</th>
                                <th>Monto</th>
                                <th>Abonado</th>
                                <th>Saldo Actual</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for g in gastos %}
                            <tr>
                                <td class="ps-4 text-muted small">{{ g.fecha.strftime('%d/%m/%Y') if g.fecha else '‚Äî' }}</td>
                                <td>
                                    <span class="fw-bold d-block text-dark">{{ g.categoria }}</span>
                                    <small class="text-muted">{{ g.concepto }}</small>
                                </td>
                                <td class="fw-bold text-dark">${{ "{:,.0f}".format(g.total) }}</td>
                                <td class="text-success fw-bold">${{ "{:,.0f}".format(g.abonado) }}</td>
                                <td>
                                    {% if g.saldo <= 0 %}
                                        <span class="badge-status bg-pagado">PAGADO</span>
                                    {% else %}
                                        <span class="text-saldo-pendiente">${{ "{:,.0f}".format(g.saldo) }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn-action-pro btn-abonar-prof" 
                                                data-bs-toggle="collapse" data-bs-target="#abonoG{{ g.id }}" 
                                                data-tooltip="Abonar / Historial">
                                            <i <button class="btn-action-prof btn-abonar-prof" data-bs-toggle="collapse" data-bs-target="#abonoG{{ g.id }}">ABONAR</button> </i>
                                        </button>
                                        
                                        <button class="btn-action-pro btn-edit-prof" 
                                                data-bs-toggle="modal" data-bs-target="#editGasto{{ g.id }}" 
                                                data-tooltip="Editar Registro">
                                            editar
                                        </button>

                                        <a href="{{ url_for('proveedores_gastos.eliminar_gasto', gasto_id=g.id) }}" 
                                           class="btn-action-pro btn-delete-prof" 
                                           data-tooltip="Eliminar"
                                           onclick="return confirm('¬øEliminar gasto y su historial?')">
                                            eliminar
                                        </a>
                                    </div>
                                </td>
                            </tr>

                            <tr class="collapse" id="abonoG{{ g.id }}">
                                <td colspan="6" class="p-0 border-0">
                                    <div class="p-4 mx-4 my-2 shadow-inner-soft">
                                        <div class="row">
                                            <div class="col-md-5 border-end pe-4">
                                                <h6 class="fw-bold mb-3"><i class="bi bi-plus-circle me-2"></i>Nuevo Abono</h6>
                                                {% if g.saldo > 0 %}
                                                <form action="{{ url_for('proveedores_gastos.abonar') }}" method="POST">
                                                    <input type="hidden" name="gasto_id" value="{{ g.id }}">
                                                    <div class="mb-3">
                                                        <input type="number" step="0.01" name="monto" max="{{ g.saldo }}" class="form-control rounded-3" placeholder="Monto a pagar..." required>
                                                        <div class="form-text text-end">Saldo pendiente: ${{ "{:,.0f}".format(g.saldo) }}</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <select name="medio" class="form-select rounded-3">
                                                            <option value="Efectivo">Efectivo</option>
                                                            <option value="Nequi">Nequi</option>
                                                            <option value="Daviplata">Daviplata</option>
                                                            <option value="Transferencia">Transferencia</option>
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <input type="date" name="fecha_abono" class="form-control rounded-3" value="{{ hoy }}">
                                                    </div>
                                                    <button type="submit" class="btn btn-success w-100 fw-bold">PROCESAR PAGO</button>
                                                </form>
                                                {% else %}
                                                <div class="alert alert-light border text-success text-center fw-bold py-4">
                                                    <i class="bi bi-check-all fs-4 d-block"></i> CUENTA SALDADA
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-7 ps-4">
                                                <h6 class="fw-bold mb-3"><i class="bi bi-clock-history me-2"></i>Historial de Pagos</h6>
                                                <div class="table-responsive" style="max-height: 200px;">
                                                    <table class="table table-sm table-borderless">
                                                        <thead class="border-bottom">
                                                            <tr class="text-muted" style="font-size: 0.7rem;">
                                                                <th>FECHA</th>
                                                                <th>MONTO</th>
                                                                <th>MEDIO</th>
                                                                <th class="text-end">BORRAR</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody style="font-size: 0.85rem;">
                                                            {% for abono in g.lista_abonos %}
                                                            <tr>
                                                                <td>{{ abono.fecha.strftime('%d/%m/%Y') }}</td>
                                                                <td class="fw-bold text-dark">${{ "{:,.0f}".format(abono.monto) }}</td>
                                                                <td><span class="badge bg-light text-dark">{{ abono.medio_pago }}</span></td>
                                                                <td class="text-end">
                                                                    <a href="{{ url_for('proveedores_gastos.eliminar_abono_proveedor', abono_id=abono.id) }}" 
                                                                       class="text-danger" onclick="return confirm('¬øBorrar pago?')">
                                                                        <i class="bi bi-trash-fill"></i>
                                                                    </a>
                                                                </td>
                                                            </tr>
                                                            {% else %}
                                                            <tr>
                                                                <td colspan="4" class="text-center py-4 text-muted small italic">No hay pagos registrados</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <p class="text-muted m-0">No se encontraron gastos registrados.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% for g in gastos %}
<div class="modal fade" id="editGasto{{ g.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST" action="{{ url_for('proveedores_gastos.editar_gasto', gasto_id=g.id) }}" class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 p-4 pb-0">
                <h5 class="modal-title fw-bold">Editar Registro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">Categor√≠a</label>
                    <select name="categoria" class="form-select bg-light border-0 p-3">
                        <option {% if g.categoria == 'Arriendo' %}selected{% endif %}>Arriendo</option>
                        <option {% if g.categoria == 'Servicios P√∫blicos' %}selected{% endif %}>Servicios P√∫blicos</option>
                        <option {% if g.categoria == 'Mantenimiento' %}selected{% endif %}>Mantenimiento</option>
                        <option {% if g.categoria == 'N√≥mina / Personal' %}selected{% endif %}>N√≥mina / Personal</option>
                        <option {% if g.categoria == 'Insumos Bodega' %}selected{% endif %}>Insumos Bodega</option>
                        <option {% if g.categoria == 'Otros' %}selected{% endif %}>Otros</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-muted mb-1 text-uppercase">Concepto</label>
                    <input type="text" name="concepto" value="{{ g.concepto }}" class="form-control bg-light border-0 p-3" required>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="small fw-bold text-muted mb-1 text-uppercase">Total ($)</label>
                        <input type="number" step="0.01" name="total" value="{{ g.total }}" class="form-control bg-light border-0 p-3" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="small fw-bold text-muted mb-1 text-uppercase">Fecha</label>
                        <input type="date" name="fecha" value="{{ g.fecha.strftime('%Y-%m-%d') if g.fecha else '' }}" class="form-control bg-light border-0 p-3">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button type="submit" class="btn btn-primary w-100 fw-bold py-3 rounded-3 shadow-sm">Actualizar Gasto</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% endblock %}