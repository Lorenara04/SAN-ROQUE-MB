{% extends "base.html" %}
{% block title %}Nueva Venta - San Roque M.B.{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/css/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    :root {
        --azul-sanroque: #1a3a5a;
        --dorado-olimpo: #b8860b;
        --bg-gris: #f1f5f9;
        --rosa-total: #fff1f2;
        --border-color: #e2e8f0;
        --success-soft: #dcfce7;
    }

    body { background-color: var(--bg-gris) !important; font-family: 'Poppins', sans-serif; }

    .venta-wrapper { 
        display: grid; 
        grid-template-columns: 1fr 1.2fr; 
        gap: 25px; 
        max-width: 1500px; 
        margin: 20px auto; 
        padding: 0 20px; 
    }

    .card-pos { background: white; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .card-pos-header { background: var(--azul-sanroque); color: white; padding: 12px 15px; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
    .card-pos-body { padding: 20px; }

    .espera-bar { background: #e2e8f0; padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .btn-pausa { background: var(--dorado-olimpo); color: white; border: none; border-radius: 8px; padding: 5px 15px; font-weight: 700; font-size: 0.75rem; transition: 0.3s; }
    .btn-pausa:hover { background: #966d09; }
    .btn-recuperar { background: white; border: 1px solid var(--azul-sanroque); color: var(--azul-sanroque); border-radius: 8px; padding: 5px 12px; font-size: 0.75rem; font-weight: 600; transition: 0.2s; }
    .btn-recuperar:hover { background: var(--azul-sanroque); color: white; }

    .form-label { font-size: 0.75rem; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 6px; }
    .form-control-pos { border-radius: 8px; border: 1.5px solid var(--border-color); padding: 10px; font-size: 0.95rem; font-weight: 600; }

    .total-box { background: var(--rosa-total); border: 1px solid #fecdd3; border-radius: 12px; padding: 25px; text-align: center; margin-bottom: 20px; }
    .total-label { font-size: 0.85rem; font-weight: 800; color: #be123c; text-transform: uppercase; }
    .total-val { font-size: 3rem; font-weight: 900; color: #1e293b; display: block; }

    .vuelto-container { background: #0f172a; border-radius: 12px; padding: 15px; text-align: center; color: white; margin-bottom: 20px; }
    .vuelto-val { font-size: 1.8rem; font-weight: 800; color: #38bdf8; display: block; }

    .btn-finalizar { background: #166534; color: white; border: none; border-radius: 10px; padding: 18px; width: 100%; font-weight: 800; font-size: 1.2rem; text-transform: uppercase; transition: 0.3s; cursor: pointer;}
    .btn-finalizar:hover { background: #14534c; transform: translateY(-2px); }

    .table-pos thead th { font-size: 0.7rem; border-bottom: 2px solid var(--border-color); padding: 12px; }

    .ref-box { background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; display: none; margin-top: 10px; }
    
    /* Estilo para resaltar el campo del escáner */
    #barcode_input { border: 2px solid var(--azul-sanroque); background-color: #fff; font-size: 1.2rem; }
    #barcode_input:focus { box-shadow: 0 0 10px rgba(26, 58, 90, 0.2); }
</style>

<script id="product-data" type="application/json">
    [{% for p in productos %}{"id":{{p.id}},"nombre":{{p.nombre|tojson}},"marca":{{p.marca|tojson if p.marca else '""'}},"codigo":"{{p.codigo}}","precio_venta":{{p.valor_venta}},"precio_costo":{{p.valor_interno}},"stock":{{p.cantidad}}}{% if not loop.last %},{% endif %}{% endfor %}]
</script>

<div class="venta-wrapper">
    <div class="col-left">
        
        <div class="espera-bar">
            <button type="button" class="btn-pausa" onclick="pausarVenta()">
                <i class="fas fa-pause-circle me-1"></i> PAUSAR VENTA
            </button>
            <div id="lista-pendientes" class="d-flex gap-2"></div>
        </div>

        <div class="card-pos">
            <div class="card-pos-header">MODO ESCÁNER ACTIVO <i class="fas fa-barcode"></i></div>
            <div class="card-pos-body">
                <input type="text" id="barcode_input" class="form-control form-control-pos" placeholder="Pase la pistola repetidamente..." autofocus autocomplete="off">
            </div>
        </div>

        <div class="card-pos">
            <div class="card-pos-header">CLIENTE <i class="fas fa-user"></i></div>
            <div class="card-pos-body">
                <select id="cliente_id_select" class="form-select select2-pos" onchange="recalcularPreciosYFocar()">
                    <option value="1" data-categoria="estandar" selected>CLIENTE GENERAL (MOSTRADOR)</option>
                    {% for c in clientes %}
                        {% if c.id != 1 %}
                        <option value="{{ c.id }}" data-categoria="{{ c.categoria }}">{{ c.nombre | upper }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="card-pos">
            <div class="card-pos-header">BÚSQUEDA MANUAL <i class="fas fa-search"></i></div>
            <div class="card-pos-body">
                <select id="manual_producto" class="form-select mb-3">
                    <option value="">-- Buscar producto --</option>
                    {% for p in productos %}
                        <option value="{{ p.id }}">
                            {{ p.nombre | upper }} | {{ p.marca | upper if p.marca else 'S.M' }}
                        </option>
                    {% endfor %}
                </select>
                <div class="row g-2">
                    <div class="col-8">
                        <input type="number" id="manual_cantidad" class="form-control form-control-pos" value="1" min="1">
                    </div>
                    <div class="col-4">
                        <button type="button" class="btn btn-primary w-100 fw-bold" onclick="agregarManual()" style="height: 48px; background: var(--azul-sanroque)">AÑADIR</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-pos">
            <div class="card-pos-header">RESUMEN DE CARRITO <i class="fas fa-shopping-cart"></i></div>
            <div class="card-pos-body p-0">
                <table class="table table-pos mb-0 text-center align-middle">
                    <thead>
                        <tr>
                            <th class="text-start ps-3">ITEM</th>
                            <th>CANT.</th>
                            <th>PRECIO</th>
                            <th class="text-end pe-3">SUBTOTAL</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="carrito-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-right">
        <form method="POST" id="form_venta" onsubmit="return validarYEnviar(event)">
            <input type="hidden" name="cliente_id" id="cliente_id_hidden" value="1">
            
            <div class="total-box shadow-sm">
                <span class="total-label">TOTAL A PAGAR</span>
                <span class="total-val">$ <span id="total-final" data-raw-total="0">0</span></span>
            </div>

            <div class="card-pos">
                <div class="card-pos-header" style="background: #be123c;">REGISTRO DE PAGO <i class="fas fa-wallet"></i></div>
                <div class="card-pos-body">
                    <div class="row g-3">
                        <div class="col-6"><label class="form-label">EFECTIVO</label><input type="number" step="any" name="pago_efectivo" id="pago_efectivo" class="form-control form-control-pos pago-input" value="0"></div>
                        <div class="col-6"><label class="form-label">NEQUI</label><input type="number" step="any" name="pago_nequi" id="pago_nequi" class="form-control form-control-pos pago-input" value="0"></div>
                        <div class="col-6"><label class="form-label">DAVIPLATA</label><input type="number" step="any" name="pago_daviplata" id="pago_daviplata" class="form-control form-control-pos pago-input" value="0"></div>
                        <div class="col-6"><label class="form-label">TARJETA</label><input type="number" step="any" name="pago_tarjeta" id="pago_tarjeta" class="form-control form-control-pos pago-input" value="0"></div>
                        <div class="col-12"><label class="form-label">TRANSFERENCIA</label><input type="number" step="any" name="pago_transferencia" id="pago_transferencia" class="form-control form-control-pos pago-input" value="0"></div>
                    </div>

                    <div class="vuelto-container mt-3 shadow-sm">
                        <span class="vuelto-label">CAMBIO</span>
                        <span id="vuelto-monto" class="vuelto-val">$ 0</span>
                    </div>

                    <div id="ref-nequi" class="ref-box"><label class="form-label">REF. NEQUI</label><input type="text" id="codigo_nequi" class="form-control form-control-pos"></div>
                    <div id="ref-daviplata" class="ref-box"><label class="form-label">REF. DAVIPLATA</label><input type="text" id="codigo_daviplata" class="form-control form-control-pos"></div>
                    <div id="ref-tarjeta" class="ref-box"><label class="form-label">REF. TARJETA</label><input type="text" id="codigo_tarjeta" class="form-control form-control-pos"></div>
                </div>
            </div>

            <button type="submit" class="btn-finalizar shadow">FINALIZAR VENTA <i class="fas fa-check-circle ms-2"></i></button>
            
            <input type="hidden" name="referencias_pago_json" id="referencias_pago_json">
            <input type="hidden" name="productos_vendidos_json" id="productos_vendidos_json">
            <input type="hidden" name="total_venta" id="total_venta_hidden">
        </form>
    </div>
</div>

<script>
    const productData = JSON.parse(document.getElementById('product-data').textContent);
    let carrito = {};

    // --- FUNCIÓN PARA MANTENER EL FOCO SIEMPRE EN EL ESCÁNER ---
    function enfocarEscaner() {
        setTimeout(() => {
            const input = document.getElementById('barcode_input');
            input.focus();
        }, 10);
    }

    function formatCurrency(v) { return v.toLocaleString('es-CO'); }

    // --- ESCÁNER AUTOMÁTICO ---
    document.getElementById('barcode_input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); 
            const codigo = this.value.trim();
            if (codigo) {
                const p = productData.find(x => x.codigo === codigo);
                if (p) {
                    const cat = getCategoriaActual();
                    const precio = (cat === 'premium') ? p.precio_costo : p.precio_venta;

                    if (carrito[p.id]) {
                        carrito[p.id].cantidad++;
                    } else {
                        carrito[p.id] = {id: p.id, nombre: p.nombre, marca: p.marca, precio: precio, cantidad: 1};
                    }
                    renderizarCarrito();
                } else {
                    alert("Producto no registrado.");
                }
            }
            this.value = '';
            enfocarEscaner(); // REGRESA EL FOCO AL TIRO
        }
    });

    function getCategoriaActual() {
        const select = document.getElementById('cliente_id_select');
        return select.options[select.selectedIndex].getAttribute('data-categoria') || 'estandar';
    }

    function recalcularPreciosYFocar() {
        const cat = getCategoriaActual();
        for (const key in carrito) {
            const p = productData.find(x => x.id == key);
            carrito[key].precio = (cat === 'premium') ? p.precio_costo : p.precio_venta;
        }
        renderizarCarrito();
        enfocarEscaner(); // SI CAMBIAN CLIENTE, VUELVE AL ESCÁNER
    }

    function renderizarCarrito() {
        const body = document.getElementById('carrito-body');
        body.innerHTML = '';
        let total = 0;
        for (const key in carrito) {
            const item = carrito[key];
            const sub = item.precio * item.cantidad;
            total += sub;
            body.innerHTML += `
                <tr>
                    <td class="text-start ps-3">
                        <span class="fw-bold d-block">${item.nombre.toUpperCase()}</span>
                        <small class="text-muted">${item.marca ? item.marca.toUpperCase() : 'S.M'}</small>
                    </td>
                    <td>${item.cantidad}</td>
                    <td class="text-muted small">$${formatCurrency(item.precio)}</td>
                    <td class="text-end pe-3 fw-bold">$${formatCurrency(sub)}</td>
                    <td><button type="button" class="btn btn-sm text-danger" onclick="eliminarItem(${key})"><i class="fas fa-times"></i></button></td>
                </tr>`;
        }
        document.getElementById('total-final').innerText = formatCurrency(total);
        document.getElementById('total-final').dataset.rawTotal = total;
        actualizarPagos();
    }

    function eliminarItem(id) {
        delete carrito[id];
        renderizarCarrito();
        enfocarEscaner(); // DESPUÉS DE BORRAR, VUELVE AL ESCÁNER
    }

    function actualizarPagos() {
        let totalPagado = 0;
        ['nequi', 'daviplata', 'tarjeta', 'transferencia'].forEach(m => {
            let el = document.getElementById(`pago_${m}`);
            if(el){
                let monto = parseFloat(el.value) || 0;
                totalPagado += monto;
                let refBox = document.getElementById(`ref-${m}`);
                if(refBox) refBox.style.display = monto > 0 ? 'block' : 'none';
            }
        });
        totalPagado += parseFloat(document.getElementById('pago_efectivo').value) || 0;
        const totalCarrito = parseFloat(document.getElementById('total-final').dataset.rawTotal) || 0;
        const diff = totalPagado - totalCarrito;

        const vueltoEl = document.getElementById('vuelto-monto');
        vueltoEl.innerText = `$ ${formatCurrency(Math.abs(diff))}`;
        vueltoEl.style.color = diff >= 0 ? '#38bdf8' : '#fb7185';
        document.querySelector('.vuelto-label').innerText = diff >= 0 ? 'CAMBIO' : 'FALTAN';
        return { totalPagado, totalCarrito };
    }

    function agregarManual() {
        const id = parseInt(document.getElementById('manual_producto').value);
        if (!id) return;
        const p = productData.find(x => x.id === id);
        const cant = parseInt(document.getElementById('manual_cantidad').value) || 1;
        const cat = getCategoriaActual();
        const precio = (cat === 'premium') ? p.precio_costo : p.precio_venta;

        if (carrito[id]) {
            carrito[id].cantidad += cant;
        } else {
            carrito[id] = { id: p.id, nombre: p.nombre, marca: p.marca, precio: precio, cantidad: cant };
        }
        renderizarCarrito();
        $('#manual_producto').val('').trigger('change');
        enfocarEscaner(); // DESPUÉS DE BÚSQUEDA MANUAL, VUELVE AL ESCÁNER
    }

    function validarYEnviar(e) {
        e.preventDefault();
        const { totalPagado, totalCarrito } = actualizarPagos();
        if (totalCarrito <= 0) return alert("Carrito vacío.");
        if (totalPagado < totalCarrito) return alert("Pago insuficiente.");

        document.getElementById('productos_vendidos_json').value = JSON.stringify(Object.values(carrito).map(i => ({...i, subtotal: i.precio * i.cantidad})));
        document.getElementById('total_venta_hidden').value = totalCarrito;
        document.getElementById('cliente_id_hidden').value = $('#cliente_id_select').val();
        document.getElementById('referencias_pago_json').value = JSON.stringify({
            Nequi: $('#codigo_nequi').val(),
            Daviplata: $('#codigo_daviplata').val(),
            Tarjeta: $('#codigo_tarjeta').val()
        });
        document.getElementById('form_venta').submit();
    }

    $(document).ready(() => {
        $('#manual_producto').select2({ theme: 'bootstrap-5' });
        $('#cliente_id_select').select2({ theme: 'bootstrap-5' });
        $('.pago-input').on('input', actualizarPagos);
        enfocarEscaner();

        // SI HACEN CLIC EN CUALQUIER LADO DEL FONDO, EL CURSOR VUELVE AL ESCÁNER
        document.addEventListener('click', function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA') {
                enfocarEscaner();
            }
        });
    });
</script>
{% endblock %}