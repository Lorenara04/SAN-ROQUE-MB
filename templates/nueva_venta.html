{% extends "base.html" %}
{% block title %}Terminal POS - SAN ROQUE MB{% endblock %}

{% block content %}
<style>
    :root {
        --azul-bebe: #e0f2fe;
        --azul-pastel: #bae6fd;
        --azul-primario: #7dd3fc;
        --azul-oscuro: #0369a1;
        --success-pastel: #dcfce7;
        --danger-pastel: #fee2e2;
        --text-main: #1e293b;
    }

    /* Estilos de Pesta√±as con bot√≥n de cierre */
    .pos-tabs-container {
        display: flex; gap: 10px; border-bottom: 3px solid var(--azul-oscuro);
        margin-bottom: 25px; overflow-x: auto; padding-bottom: 10px; align-items: center;
    }
    
    .pos-tab-wrapper { 
        position: relative; 
        display: flex; 
        align-items: center; 
    }

    .pos-tab {
        padding: 12px 45px 12px 20px; /* Espacio para la X */
        border-radius: 15px 15px 0 0; 
        background: var(--azul-bebe);
        border: 1px solid var(--azul-primario); 
        border-bottom: none; 
        color: var(--azul-oscuro);
        text-decoration: none; 
        font-weight: 800; 
        font-size: 0.85rem;
        display: flex; 
        align-items: center; 
        transition: 0.3s; 
        white-space: nowrap;
    }

    .pos-tab.active {
        background: var(--azul-oscuro); 
        color: white; 
        border-color: var(--azul-oscuro);
        box-shadow: 0 -5px 15px rgba(3, 105, 161, 0.2);
    }

    /* Bot√≥n X para borrar pesta√±a */
    .btn-close-tab {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.1);
        color: var(--azul-oscuro);
        border: none;
        border-radius: 50%;
        width: 22px;
        height: 22px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
        z-index: 5;
    }
    .pos-tab.active + .btn-close-tab { color: white; background: rgba(255, 255, 255, 0.2); }
    .btn-close-tab:hover { background: #ef4444 !important; color: white !important; transform: translateY(-50%) scale(1.1); }

    .btn-quick-add {
        border-radius: 50%; width: 42px; height: 42px;
        background: var(--azul-oscuro); color: white; border: none;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; transition: 0.3s; text-decoration: none;
    }
    .btn-quick-add:hover { background: var(--text-main); transform: scale(1.1); color: white; }
    
    .pos-card { border-radius: 20px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
    .qty-input {
        width: 70px; text-align: center; font-weight: bold;
        border: 2px solid var(--azul-pastel); border-radius: 8px;
    }
    
    /* Evitar que el input se vea azul feo al tener el foco siempre */
    #barcode_input:focus {
        border-color: var(--azul-primario);
        box-shadow: 0 0 0 0.25rem rgba(125, 211, 252, 0.25);
    }
</style>

<div class="container-fluid mt-4">
    <div class="pos-tabs-container">
        {% for v in pesta√±as_activas %}
        <div class="pos-tab-wrapper">
            <a href="{{ url_for('ventas.ver_mesa', mesa_id=v.mesa_id) }}" 
               class="pos-tab {% if venta.id == v.id %}active{% endif %}">
                <i class="fas fa-receipt me-2"></i> 
                {{ v.nombre_cliente | upper }}
                <span class="badge {% if venta.id == v.id %}bg-light text-dark{% else %}bg-primary{% endif %} ms-2">
                    $ {{ v.total | format_number }}
                </span>
            </a>
            <button class="btn-close-tab" onclick="confirmarBorrarPesta√±a({{ v.id }}, '{{ v.nombre_cliente }}')" title="Cerrar orden">
                <i class="fas fa-times"></i>
            </button>
        </div>
        {% endfor %}
        
        <a href="{{ url_for('ventas.abrir_pestana') }}" class="btn-quick-add ms-3 shadow-sm" title="Venta R√°pida">
            <i class="fas fa-plus"></i>
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card pos-card p-4 bg-white mb-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="fw-bold m-0 text-dark">
                            IDENTIFICACI√ìN: <span class="text-primary">{{ venta.nombre_cliente | upper }}</span>
                        </h4>
                        <div class="mt-2">
                            <select id="select_cliente" class="form-select form-select-sm border-primary fw-bold" onchange="asignarCliente(this.value)" style="max-width: 280px;">
                                <option value="">üë§ ASIGNAR CLIENTE (Opcional)</option>
                                {% for c in clientes %}
                                <option value="{{ c.id }}" {% if venta.cliente_id == c.id %}selected{% endif %}>
                                    {{ c.nombre | upper }} {% if c.tipo == 'premium' %}(‚≠ê PREMIUM){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <span class="badge bg-light text-muted border px-3 py-2">TICKET #{{ venta.id }}</span>
                </div>

                <div class="input-group input-group-lg mb-4 shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-barcode text-primary"></i></span>
                    <input type="text" id="barcode_input" class="form-control border-start-0 fw-bold" 
                           placeholder="ESCANE√â C√ìDIGO AHORA..." autofocus autocomplete="off">
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th class="ps-4">Descripci√≥n</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Precio</th>
                                <th class="text-end">Subtotal</th>
                                <th class="text-center"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in detalles %}
                            <tr id="fila-{{ d.id }}">
                                <td class="ps-4 fw-bold text-dark">{{ d.producto.nombre | upper }}</td>
                                <td class="text-center">
                                    <input type="number" class="qty-input" value="{{ d.cantidad }}" min="1"
                                           onchange="actualizarCantidad({{ d.id }}, this.value)">
                                </td>
                                <td class="text-end text-muted">{{ d.precio_unitario | format_number }}</td>
                                <td class="text-end fw-bold text-primary" id="subtotal-{{ d.id }}">
                                     $ {{ d.subtotal | format_number }}
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-link text-danger p-0" onclick="eliminarProducto({{ d.id }})">
                                        <i class="fas fa-trash-alt fa-lg"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card pos-card p-4 bg-white border-top border-5 border-success">
                <div class="text-center mb-4">
                    <h6 class="text-muted fw-bold mb-1">TOTAL A PAGAR</h6>
                    <h1 class="display-4 fw-bold text-dark" id="total-display">
                         $ {{ venta.total | format_number }}
                    </h1>
                </div>

                <div class="mb-3">
                    <label class="form-label small fw-bold text-muted">MEDIO DE PAGO</label>
                    <select id="metodo_pago" class="form-select form-select-lg fw-bold border-primary">
                        <option value="EFECTIVO">üíµ Efectivo</option>
                        <option value="NEQUI">üì≤ Nequi</option>
                        <option value="DAVIPLATA">üì≤ Daviplata</option>
                        <option value="TARJETA">üí≥ Tarjeta</option>
                    </select>
                </div>

                <div class="mb-3" id="contenedor-efectivo">
                    <label class="form-label small fw-bold text-muted">¬øCON CU√ÅNTO PAGA?</label>
                    <div class="input-group input-group-lg">
                        <span class="input-group-text bg-success text-white border-0">$</span>
                        <input type="number" id="pago_efectivo" class="form-control fw-bold text-success" placeholder="0">
                    </div>
                </div>

                <div class="alert alert-secondary border-0 rounded-4 text-center py-3 mb-4">
                    <small class="fw-bold text-muted d-block mb-1">SU CAMBIO</small>
                    <h3 class="m-0 fw-bold text-dark" id="cambio-txt">$ 0</h3>
                </div>

                <button class="btn btn-success btn-lg w-100 py-3 fw-bold shadow-sm" onclick="cerrarVenta()">
                    <i class="fas fa-file-invoice-dollar me-2"></i> FINALIZAR Y FACTURAR
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let totalVentaGlobal = {{ venta.total }};
let ventaIdActual = {{ venta.id }};

// --- FUNCI√ìN PARA MANTENER EL FOCO SIEMPRE ---
function resetFocus() {
    document.getElementById('barcode_input').focus();
}

window.onload = resetFocus;

// Si el usuario hace clic fuera, devolvemos el cursor al input despu√©s de un segundo
document.addEventListener('click', function(e) {
    if(e.target.id !== 'select_cliente' && e.target.id !== 'metodo_pago' && e.target.id !== 'pago_efectivo') {
        setTimeout(resetFocus, 500);
    }
});

function formatMoney(amount) {
    return '$ ' + Number(amount).toLocaleString('de-DE');
}

// BORRAR PESTA√ëA COMPLETAMENTE
function confirmarBorrarPesta√±a(ventaId, nombre) {
    Swal.fire({
        title: `¬øBorrar ${nombre}?`,
        text: "Se eliminar√°n los productos y se liberar√° la mesa.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonText: 'Cancelar',
        confirmButtonText: 'S√≠, borrar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/ventas/eliminar_venta/${ventaId}`, { method: "POST" })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    if(ventaId == ventaIdActual) window.location.href = "{{ url_for('ventas.dashboard') }}";
                    else location.reload();
                }
            });
        } else {
            resetFocus();
        }
    });
}

// ESC√ÅNER / LECTOR DE BARRAS
document.getElementById('barcode_input').addEventListener('keydown', function(e){
    if(e.key === "Enter"){
        e.preventDefault();
        let codigo = e.target.value.trim();
        if(codigo !== ""){
            fetch("/ventas/buscar_producto/" + codigo)
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    agregarProductoAjax(data.producto_id);
                } else {
                    Swal.fire({title: "No encontrado", icon: "warning", timer: 1000, showConfirmButton: false});
                    resetFocus();
                }
            });
        }
        e.target.value = "";
    }
});

function agregarProductoAjax(productoId){
    fetch("{{ url_for('ventas.agregar_producto') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ venta_id: ventaIdActual, producto_id: productoId })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) location.reload();
        else {
            Swal.fire("Error", data.message, "error");
            resetFocus();
        }
    });
}

function asignarCliente(clienteId) {
    if(!clienteId) return;
    fetch("{{ url_for('ventas.asignar_cliente') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ venta_id: ventaIdActual, cliente_id: clienteId })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) location.reload();
    });
}

function actualizarCantidad(detalleId, nuevaCantidad) {
    if(nuevaCantidad < 1) return;
    fetch("{{ url_for('ventas.actualizar_cantidad') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ detalle_id: detalleId, cantidad: nueva_cantidad })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            document.getElementById(`subtotal-${detalleId}`).innerText = formatMoney(data.nuevo_subtotal);
            document.getElementById('total-display').innerText = formatMoney(data.nuevo_total);
            totalVentaGlobal = data.nuevo_total;
            resetFocus();
        }
    });
}

function eliminarProducto(detalleId){
    fetch("{{ url_for('ventas.eliminar_producto') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ detalle_id: detalleId })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            document.getElementById(`fila-${detalleId}`).remove();
            document.getElementById('total-display').innerText = formatMoney(data.nuevo_total);
            totalVentaGlobal = data.nuevo_total;
            resetFocus();
        }
    });
}

document.getElementById('pago_efectivo').addEventListener('input', function(e){
    let pago = parseFloat(e.target.value) || 0;
    let cambio = pago - totalVentaGlobal;
    document.getElementById('cambio-txt').innerText = cambio > 0 ? formatMoney(cambio) : '$ 0';
});

document.getElementById('metodo_pago').addEventListener('change', function(e){
    let metodo = e.target.value;
    let contenedor = document.getElementById('contenedor-efectivo');
    if(metodo === "EFECTIVO"){
        contenedor.style.display = "block";
        document.getElementById('pago_efectivo').focus();
    } else {
        contenedor.style.display = "none";
        document.getElementById('pago_efectivo').value = totalVentaGlobal;
        document.getElementById('cambio-txt').innerText = '$ 0';
        resetFocus();
    }
});

function cerrarVenta(){
    let metodo = document.getElementById("metodo_pago").value;
    let efec = parseFloat(document.getElementById("pago_efectivo").value) || 0;

    if(metodo === "EFECTIVO" && efec < totalVentaGlobal){
        return Swal.fire("Monto insuficiente", "El efectivo no cubre el total", "error").then(resetFocus);
    }

    fetch("{{ url_for('ventas.cerrar_venta') }}", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ venta_id: ventaIdActual, metodo_pago: metodo, pago_efectivo: efec })
    })
    .then(res => res.json())
    .then(data => {
        if(data.success) {
            Swal.fire("Venta Cerrada", "Generando ticket...", "success")
            .then(() => window.location.href = data.redirect_url);
        }
    });
}
</script>
{% endblock %}