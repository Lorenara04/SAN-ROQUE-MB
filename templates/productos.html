{% extends "base.html" %}
{% block title %}Inventario - SAN ROQUE M.B{% endblock %}
{% block page %}Inventario{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root {
  --azul-olimpo: #1a3a5a;
  --azul-premium: #2c5282;
  --azul-acero: #4a69bd;
  --azul-claro: #d1e3f5;
  --slate-800: #1e293b;
  --success-green: #15803d;
  --danger-red: #b91c1c;
  --rosa-tag: #28459e; 
}

/* Identidad Visual */
.header-inventario {
  background: linear-gradient(135deg, var(--azul-olimpo), var(--azul-premium));
  color: white; padding: 35px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 30px;
}

.card-search-premium {
  background: white; border-radius: 40px; padding: 8px; box-shadow: 0 15px 35px rgba(0,0,0,0.06);
  border: 3px solid var(--azul-olimpo); margin-bottom: 30px; display: flex; align-items: center;
}

.search-container-inner { position: relative; display: flex; align-items: center; width: 100%; padding: 5px 25px; }
.search-container-inner i { font-size: 1.4rem; color: var(--azul-olimpo); margin-right: 15px; }
.search-container-inner input { border: none; background: transparent; width: 100%; font-size: 1.2rem; font-weight: 600; outline: none !important; }

/* Tabla Maestro */
.tabla-container {
  background: white; border-radius: 25px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid var(--azul-claro);
}

.table thead th {
  background: #f8fafc !important; color: var(--slate-800) !important;
  text-transform: uppercase; font-size: 0.7rem; letter-spacing: 1.5px; padding: 20px; border-bottom: 2px solid var(--azul-claro);
}

.badge-stock { padding: 8px 14px; border-radius: 12px; font-weight: 800; font-size: 0.7rem; display: inline-flex; align-items: center; gap: 5px; }
.stock-top { background: #dcfce7; color: var(--success-green); }
.stock-low { background: #fee2e2; color: var(--danger-red); animation: pulse 2s infinite; }

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

.btn-action-base {
  width: 38px; height: 38px; border-radius: 10px; display: inline-flex;
  align-items: center; justify-content: center; border: none; color: #fff; transition: 0.3s;
}
.btn-action-edit { background: var(--azul-premium); }
.btn-action-delete { background: var(--danger-red); }
.btn-action-barcode { background: var(--rosa-tag); }
.btn-action-stock { background: var(--azul-acero); }

/* Historial Actividad */
.historial-clean { background: white; border-radius: 20px; padding: 25px; border: 1px solid var(--azul-claro); }
.movimiento-item { 
    display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9; 
    transition: 0.2s; font-size: 0.85rem;
}
.movimiento-item:hover { background: #f8fafc; }
.movimiento-icon { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
.icon-entrada { background: #dcfce7; color: #15803d; }
.icon-salida { background: #fee2e2; color: #b91c1c; }

/* Utilidades Modales */
.bg-ganancia-box { background-color: #f0fdf4; border: 2px dashed #22c55e; border-radius: 15px; padding: 15px; text-align: center; }
.btn-porcentaje { padding: 8px 15px; font-size: 0.85rem; border-radius: 12px; border: 2px solid var(--azul-claro); background: #f8fafc; font-weight: bold; cursor: pointer; }

@media print {
    body * { visibility: hidden; }
    #area-impresion-barcode, #area-impresion-barcode * { visibility: visible; }
    #area-impresion-barcode { position: absolute; left: 0; top: 0; width: 100%; display: flex !important; justify-content: center; align-items: center; height: 100vh; }
}
</style>

<div class="container py-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <script>
            Swal.fire({
              icon: "{{ 'error' if category == 'error' else 'success' }}",
              title: "{{ '¡Vaya!' if category == 'error' else '¡Excelente!' }}",
              text: "{{ message }}",
              confirmButtonColor: '#1a3a5a'
            });
          </script>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="header-inventario d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-1 fw-bold"><i class="fas fa-wine-bottle me-2"></i> Gestión de Cava</h1>
            <p class="mb-0 opacity-75">San Roque M.B - Inventario Inteligente</p>
        </div>
        <div class="d-flex gap-2">
            {% if current_user.rol.lower() == 'administrador' %}
            <button class="btn btn-light fw-bold px-4 py-2 rounded-pill shadow" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus-circle me-2 text-primary"></i> NUEVO PRODUCTO
            </button>
            {% endif %}
        </div>
    </div>

    <div class="card-search-premium">
        <div class="search-container-inner">
            <i class="fas fa-search"></i>
            <input type="text" id="globalSearch" placeholder="Escanea el código que da error para ELIMINARLO..." autofocus autocomplete="off">
        </div>
    </div>

    <div class="tabla-container">
        <table class="table text-center align-middle mb-0">
            <thead>
                <tr>
                    <th>Ref. Código</th>
                    <th class="text-start">Nombre / Detalle</th>
                    <th>Estado Stock</th>
                    <th>Precio Venta</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="inventoryBody">
                {% for p in productos_paginados.items %}
                <tr class="product-row">
                    <td><span class="badge bg-light text-primary border fw-bold">{{ p.codigo or 'N/A' }}</span></td>
                    <td class="text-start">
                        <div class="fw-bold text-dark">{{ p.nombre | upper if p.nombre else 'REGISTRO SIN NOMBRE' }}</div>
                        <div class="small text-muted text-uppercase">{{ p.marca or 'S.M' }}</div>
                    </td>
                    <td>
                        <span class="badge-stock {% if p.cantidad > 5 %}stock-top{% else %}stock-low{% endif %}">
                            <i class="fas {% if p.cantidad > 5 %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i> {{ p.cantidad }} UND
                        </span>
                    </td>
                    <td><span class="fw-bold text-dark fs-5">${{ "{:,.0f}".format(p.valor_venta or 0) }}</span></td>
                    <td>
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn-action-base btn-action-stock" onclick="openStockModal('{{ p.id }}', '{{ p.nombre|e }}', '{{ p.cantidad }}')" title="Ajustar Stock"><i class="fas fa-cubes"></i></button>
                            <button class="btn-action-base btn-action-barcode" onclick="verEtiqueta('{{ p.codigo }}', '{{ p.nombre|e }}', '{{ p.marca|e }}', '{{ p.valor_venta }}')" title="Etiqueta"><i class="fas fa-barcode"></i></button>
                            {% if current_user.rol.lower() == 'administrador' %}
                            <button class="btn-action-base btn-action-edit" onclick="openEditModal('{{ p.id }}', '{{ p.nombre|e }}', '{{ p.marca|e }}', '{{ p.codigo|e }}', '{{ p.valor_interno }}', '{{ p.valor_venta }}', '{{ p.cantidad }}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <a class="btn-action-base btn-action-delete" href="{{ url_for('inventario.eliminar_producto', producto_id=p.id) }}" onclick="return confirm('¿Seguro desea ELIMINAR permanentemente este registro?')"><i class="fas fa-trash-alt"></i></a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div id="pagination-controls" class="d-flex justify-content-between align-items-center p-4 bg-light border-top">
            <div class="text-muted small fw-bold">Página {{ productos_paginados.page }} de {{ productos_paginados.pages }}</div>
            <nav>
                <ul class="pagination mb-0">
                    {% if productos_paginados.has_prev %}
                    <li class="page-item"><a class="page-link rounded-pill px-3 me-2" href="{{ url_for('inventario.inventario', page=productos_paginados.prev_num) }}">Anterior</a></li>
                    {% endif %}
                    {% if productos_paginados.has_next %}
                    <li class="page-item"><a class="page-link rounded-pill px-3" href="{{ url_for('inventario.inventario', page=productos_paginados.next_num) }}">Siguiente</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>

    <div class="mt-5">
        <h5 class="fw-bold text-dark mb-3"><i class="fas fa-history me-2 text-primary"></i>Actividad Reciente de Bodega</h5>
        <div class="historial-clean shadow-sm">
            {% for m in historial %}
            <div class="movimiento-item">
                <div class="movimiento-icon {% if m.cantidad > 0 %}icon-entrada{% else %}icon-salida{% endif %}">
                    <i class="fas {% if m.cantidad > 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="fw-bold text-dark">{{ m.producto.nombre | upper if m.producto.nombre else 'ITEM ELIMINADO' }}</div>
                    <div class="text-muted small">{{ m.tipo }} por <b>{{ m.usuario }}</b></div>
                </div>
                <div class="text-end">
                    <div class="fw-bold {% if m.cantidad > 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ '+' if m.cantidad > 0 }}{{ m.cantidad }} UND
                    </div>
                    <div class="text-muted" style="font-size: 0.7rem;">{{ m.fecha.strftime('%d/%m - %H:%M') }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <form action="{{ url_for('inventario.crear_producto') }}" method="POST">
                <div class="modal-header bg-primary text-white p-4" style="border-radius: 25px 25px 0 0;">
                    <h5 class="modal-title fw-bold">REGISTRAR PRODUCTO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <div class="row g-4">
                        <div class="col-12"><label class="fw-bold">CÓDIGO</label><input name="codigo" class="form-control" required></div>
                        <div class="col-md-8"><label class="fw-bold">Nombre</label><input name="nombre" class="form-control" required></div>
                        <div class="col-md-4"><label class="fw-bold">Marca</label><input name="marca" class="form-control"></div>
                        <div class="col-md-6"><label class="fw-bold text-primary">Costo</label><input name="valor_interno" id="new_costo" type="number" step="0.01" class="form-control" oninput="calcularMargen('new_costo', 'new_venta', 'new_ganancia', null)"></div>
                        <div class="col-md-6"><label class="fw-bold">Stock Inicial</label><input name="cantidad" type="number" class="form-control" value="0"></div>
                        <div class="col-12">
                            <label class="small fw-bold text-muted">CALCULAR POR % GANANCIA:</label>
                            <select class="form-select border-primary" onchange="calcularMargen('new_costo', 'new_venta', 'new_ganancia', this.value)">
                                <option value="">-- Seleccionar --</option>
                                {% for i in range(5, 71, 5) %}<option value="{{ i }}">{{ i }}%</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6"><label class="fw-bold text-success">Precio Venta</label><input name="valor_venta" id="new_venta" type="number" step="0.01" class="form-control" oninput="calcularMargen('new_costo', 'new_venta', 'new_ganancia', null)"></div>
                        <div class="col-md-6"><div class="bg-ganancia-box"><span id="new_ganancia" class="h5 fw-bold text-success">$ 0</span></div></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4"><button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill">GUARDAR</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <form method="POST" id="editForm">
                <div class="modal-header bg-dark text-white p-4" style="border-radius: 25px 25px 0 0;">
                    <h5 class="modal-title fw-bold">EDITAR / CORREGIR</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-light">
                    <div class="row g-4">
                        <div class="col-12"><label class="fw-bold">CÓDIGO (Si aparece N/A cámbialo aquí)</label><input name="codigo" id="edit_codigo" class="form-control"></div>
                        <div class="col-md-8"><label class="fw-bold">Nombre</label><input name="nombre" id="edit_nombre" class="form-control" required></div>
                        <div class="col-md-4"><label class="fw-bold">Marca</label><input name="marca" id="edit_marca" class="form-control"></div>
                        <div class="col-md-6"><label class="fw-bold text-primary">Costo</label><input name="valor_interno" id="edit_costo" type="number" step="0.01" class="form-control" oninput="calcularMargen('edit_costo', 'edit_venta', 'edit_ganancia', null)"></div>
                        <div class="col-md-6"><label class="fw-bold">Stock</label><input name="cantidad" id="edit_cantidad" type="number" class="form-control"></div>
                        <div class="col-12">
                            <select class="form-select border-primary" id="dropdown_edit" onchange="calcularMargen('edit_costo', 'edit_venta', 'edit_ganancia', this.value)">
                                <option value="">-- Ajustar Margen % --</option>
                                {% for i in range(5, 71, 5) %}<option value="{{ i }}">{{ i }}%</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6"><label class="fw-bold text-success">Precio Venta</label><input name="valor_venta" id="edit_venta" type="number" step="0.01" class="form-control" oninput="calcularMargen('edit_costo', 'edit_venta', 'edit_ganancia', null)"></div>
                        <div class="col-md-6"><div class="bg-ganancia-box"><span id="edit_ganancia" class="h5 fw-bold text-success">$ 0</span></div></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4"><button type="submit" class="btn btn-dark w-100 py-3 fw-bold rounded-pill">ACTUALIZAR DATOS</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <form action="" method="POST" id="stockForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold"><i class="fas fa-cubes me-2"></i>AJUSTAR STOCK</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <h4 id="stock_nombre_prod" class="fw-bold text-primary mb-4"></h4>
                    <div class="row g-3">
                        <div class="col-6"><label class="small fw-bold">ACTUAL</label><input type="number" id="stock_actual" class="form-control text-center bg-light border-0" readonly></div>
                        <div class="col-6"><label class="small fw-bold text-primary">AÑADIR</label><input type="number" name="cantidad_sumar" id="cantidad_sumar" class="form-control text-center" value="0" oninput="calcularNuevoTotal()"></div>
                        <div class="col-12 mt-4"><div class="p-3 bg-dark rounded-3 text-white"><small class="fw-bold">STOCK FINAL</small><div id="stock_nuevo_total" class="h1 fw-bold text-info mb-0">0</div></div></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4"><button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill">CONFIRMAR</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="barcodeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-body text-center p-5">
                <div id="area-impresion-barcode">
                    <div class="card-etiqueta-print">
                        <h4 id="tag-nombre" class="fw-bold text-primary"></h4>
                        <p id="tag-marca" class="text-muted small mb-1"></p>
                        <div class="precio-tag" id="tag-precio"></div>
                        <div class="mt-2"><img id="tag-barcode-img" src="" style="max-width: 100%;"><p class="fw-bold mt-1"><code id="tag-codigo-texto"></code></p></div>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button class="btn btn-outline-primary fw-bold" onclick="window.print()">IMPRIMIR</button>
                    <button class="btn btn-secondary fw-bold" data-bs-dismiss="modal">CERRAR</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// BUSCADOR GLOBAL AJAX REFORZADO (Busca errores N/A)
document.getElementById('globalSearch').addEventListener('input', function() {
    let query = this.value.trim();
    let tbody = document.getElementById('inventoryBody');
    let pagination = document.getElementById('pagination-controls');

    if (query.length >= 2) {
        pagination.classList.add('d-none');
        fetch(`/api/productos/buscar?q=${query}`)
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-muted">No se encontró. Puedes crearlo como NUEVO.</td></tr>';
                } else {
                    data.forEach(p => {
                        tbody.innerHTML += `
                            <tr class="product-row">
                                <td><span class="badge bg-warning text-dark border">${p.codigo || 'N/A'}</span></td>
                                <td class="text-start"><b>${p.nombre || 'ERROR: SIN NOMBRE'}</b></td>
                                <td><span class="badge-stock stock-top">${p.stock} UND</span></td>
                                <td><span class="fw-bold">$${p.precio.toLocaleString()}</span></td>
                                <td>
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button class="btn-action-base btn-action-edit" onclick="openEditModal('${p.id}', '${p.nombre}', '', '${p.codigo}', '', '${p.precio}', '${p.stock}')"><i class="fas fa-edit"></i></button>
                                        <a class="btn-action-base btn-action-delete" href="/inventario/eliminar_producto/${p.id}" onclick="return confirm('¿Eliminar permanentemente este registro con error?')"><i class="fas fa-trash-alt"></i></a>
                                    </div>
                                </td>
                            </tr>`;
                    });
                }
            });
    } else if (query.length === 0) {
        location.reload();
    }
});

function calcularMargen(idCosto, idVenta, idGanancia, porcentaje) {
    const costo = parseFloat(document.getElementById(idCosto).value) || 0;
    const ventaInput = document.getElementById(idVenta);
    if (porcentaje) ventaInput.value = Math.round(costo * (1 + (parseInt(porcentaje) / 100)));
    const ganancia = (parseFloat(ventaInput.value) || 0) - costo;
    document.getElementById(idGanancia).innerText = '$ ' + ganancia.toLocaleString();
}

function openStockModal(id, nombre, actual) {
    document.getElementById('stock_nombre_prod').innerText = (nombre || 'PRODUCTO').toUpperCase();
    document.getElementById('stock_actual').value = actual;
    document.getElementById('cantidad_sumar').value = 0;
    document.getElementById('stock_nuevo_total').innerText = actual;
    document.getElementById('stockForm').action = "/inventario/ajustar_stock/" + id;
    new bootstrap.Modal(document.getElementById('stockModal')).show();
}

function calcularNuevoTotal() {
    const actual = parseInt(document.getElementById('stock_actual').value) || 0;
    const sumar = parseInt(document.getElementById('cantidad_sumar').value) || 0;
    document.getElementById('stock_nuevo_total').innerText = actual + sumar;
}

function openEditModal(id, nombre, marca, codigo, costo, venta, cantidad) {
    document.getElementById('edit_nombre').value = nombre || '';
    document.getElementById('edit_marca').value = marca || '';
    document.getElementById('edit_codigo').value = codigo || '';
    document.getElementById('edit_costo').value = costo || 0;
    document.getElementById('edit_venta').value = venta || 0;
    document.getElementById('edit_cantidad').value = cantidad || 0;
    document.getElementById('editForm').action = "/inventario/editar/" + id;
    calcularMargen('edit_costo', 'edit_venta', 'edit_ganancia', null);
    new bootstrap.Modal(document.getElementById('editProductModal')).show();
}

function verEtiqueta(codigo, nombre, marca, precio) {
    document.getElementById('tag-nombre').innerText = (nombre || 'PRODUCTO').toUpperCase();
    document.getElementById('tag-marca').innerText = marca || 'SAN ROQUE MB';
    document.getElementById('tag-codigo-texto').innerText = codigo;
    document.getElementById('tag-precio').innerText = '$ ' + precio;
    document.getElementById('tag-barcode-img').src = `/generar_codigo/${codigo}`;
    new bootstrap.Modal(document.getElementById('barcodeModal')).show();
}
</script>
{% endblock %}