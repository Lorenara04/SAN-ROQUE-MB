{% extends "base.html" %}
{% block title %}Inventario - SAN ROQUE M.B{% endblock %}
{% block page %}Inventario{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
:root {
  --azul-bebe: #e0f2fe;
  --azul-pastel: #bae6fd;
  --azul-primario: #7dd3fc;
  --azul-oscuro: #0369a1;
  --blanco-puro: #ffffff;
  --success-pastel: #dcfce7;
  --danger-pastel: #fee2e2;
  --text-main: #1e293b;
}

body { background-color: #f8fafc; color: var(--text-main); }

.header-inventario {
  background: linear-gradient(135deg, var(--azul-pastel), var(--azul-bebe));
  color: var(--azul-oscuro); padding: 35px; border-radius: 25px; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; border: 1px solid var(--azul-primario);
}

.card-search-premium {
  background: white; border-radius: 40px; padding: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.03);
  border: 2px solid var(--azul-primario); margin-bottom: 30px; display: flex; align-items: center;
}

.search-container-inner { display: flex; align-items: center; width: 100%; padding: 0 20px; }
.search-container-inner i { color: var(--azul-oscuro); font-size: 1.2rem; margin-right: 15px; }
.search-container-inner input { border: none; background: transparent; width: 100%; font-size: 1.1rem; outline: none !important; }

.tabla-container {
  background: white; border-radius: 25px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.02); border: 1px solid var(--azul-pastel);
}

.table thead th {
  background: var(--azul-bebe) !important; color: var(--azul-oscuro) !important;
  text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; padding: 20px; border: none;
}

.product-row:hover { background-color: #173950; }
.stock-alert-critical { background-color: #fff1f2 !important; border-left: 5px solid #fb7185 !important; }

.badge-stock { padding: 8px 14px; border-radius: 12px; font-weight: 700; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 5px; }
.stock-top { background: var(--success-pastel); color: #166534; }
.stock-low { background: var(--danger-pastel); color: #991b1b; animation: pulse 2s infinite; }

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

.btn-action-base {
  width: 38px; height: 38px; border-radius: 12px; display: inline-flex;
  align-items: center; justify-content: center; border: none; color: white; transition: 0.2s;
}
.btn-action-edit { background: #38bdf8; }
.btn-action-delete { background: #fb7185; }
.btn-action-barcode { background: #818cf8; }
.btn-action-stock { background: #2dd4bf; }
.btn-action-base:hover { transform: translateY(-2px); filter: brightness(1.1); }

.historial-section { background: white; border-radius: 25px; padding: 25px; border: 1px solid var(--azul-pastel); margin-top: 40px; }
.movimiento-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
.movimiento-icon { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
.icon-entrada { background: var(--success-pastel); color: #15803d; }
.icon-salida { background: var(--danger-pastel); color: #b91c1c; }

.bg-ganancia-box { background-color: #f0fdf4; border: 2px dashed #4ade80; border-radius: 20px; padding: 15px; text-align: center; margin-bottom: 15px; }
.bg-total-box { background-color: var(--azul-bebe); border: 1px solid var(--azul-primario); border-radius: 15px; padding: 12px; text-align: center; }
.label-total { font-size: 0.65rem; font-weight: 800; color: var(--azul-oscuro); text-transform: uppercase; margin-bottom: 3px; display: block; }
.value-total { font-size: 1rem; font-weight: 800; color: var(--text-main); }

/* Estilo Etiqueta Impresión */
.card-etiqueta-print { border: 2px solid #eee; border-radius: 20px; padding: 25px; text-align: center; background: white; max-width: 320px; margin: 0 auto; }
.precio-tag { background: #f1f5f9; color: #1e293b; font-size: 1.8rem; font-weight: 900; padding: 10px 20px; border-radius: 15px; display: inline-block; margin: 15px 0; border: 1px solid #cbd5e1; }

@media print {
    body * { visibility: hidden; }
    #area-impresion-barcode, #area-impresion-barcode * { visibility: visible; }
    #area-impresion-barcode { position: absolute; left: 0; top: 0; width: 100%; display: flex !important; justify-content: center; align-items: center; height: 100vh; }
}
</style>

<div class="container py-4">
    <div class="header-inventario d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-1 fw-bold"><i class="fas fa-wine-bottle me-2"></i> Gestión de Cava</h1>
            <p class="mb-0 opacity-75">San Roque M.B - Inventario Maestro</p>
        </div>
        <div class="d-flex gap-2">
            {% if current_user.rol.lower() == 'administrador' %}
            <button class="btn btn-white fw-bold px-4 py-2 rounded-pill shadow-sm" style="background: white; color: var(--azul-oscuro);" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus-circle me-1"></i> NUEVO PRODUCTO
            </button>
            {% endif %}
        </div>
    </div>

    <div class="card-search-premium">
        <div class="search-container-inner">
            <i class="fas fa-search"></i>
            <input type="text" id="globalSearch" placeholder="Busca por nombre, marca o código..." autofocus autocomplete="off">
        </div>
    </div>

    <div class="tabla-container">
        <table class="table text-center align-middle mb-0">
            <thead>
                <tr>
                    <th>Ref. Código</th>
                    <th class="text-start">Nombre / Detalle</th>
                    <th>Estado Stock</th>
                    <th>Precio Venta</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="inventoryBody">
                {% for p in productos_paginados.items %}
                <tr class="product-row {% if p.cantidad <= 3 %}stock-alert-critical{% endif %}">
                    <td><span class="badge bg-light text-primary border fw-bold">{{ p.codigo or 'AUTO' }}</span></td>
                    <td class="text-start">
                        <div class="fw-bold text-dark">{{ p.nombre | upper }}</div>
                        <div class="small text-muted">{{ p.marca or 'SIN MARCA' }}</div>
                    </td>
                    <td>
                        <span class="badge-stock {% if p.cantidad > 5 %}stock-top{% else %}stock-low{% endif %}">
                            <i class="fas {% if p.cantidad > 5 %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i> {{ p.cantidad }} UND
                        </span>
                    </td>
                    <td><span class="fw-bold text-dark fs-5">${{ "{:,.0f}".format(p.valor_venta or 0) }}</span></td>
                    <td>
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn-action-base btn-action-stock" onclick="openStockModal('{{ p.id }}', '{{ p.nombre|e }}', '{{ p.cantidad }}')" title="Stock"><i class="fas fa-cubes"></i></button>
                            <button class="btn-action-base btn-action-barcode" onclick="verEtiqueta('{{ p.codigo }}', '{{ p.nombre|e }}', '{{ p.marca|e }}', '{{ p.valor_venta }}')" title="Etiqueta"><i class="fas fa-barcode"></i></button>
                            {% if current_user.rol.lower() == 'administrador' %}
                            <button class="btn-action-base btn-action-edit" onclick="openEditModal('{{ p.id }}', '{{ p.nombre|e }}', '{{ p.marca|e }}', '{{ p.codigo|e }}', '{{ p.valor_interno }}', '{{ p.valor_venta }}', '{{ p.cantidad }}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <a class="btn-action-base btn-action-delete" href="{{ url_for('inventario.eliminar_producto', producto_id=p.id) }}" onclick="return confirm('¿Eliminar?')"><i class="fas fa-trash-alt"></i></a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="historial-section">
        <h5 class="fw-bold mb-4 text-dark"><i class="fas fa-history me-2" style="color: var(--azul-oscuro);"></i>Movimientos de Bodega</h5>
        {% for m in historial %}
        <div class="movimiento-item">
            <div class="movimiento-icon {% if m.cantidad > 0 %}icon-entrada{% else %}icon-salida{% endif %}">
                <i class="fas {% if m.cantidad > 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i>
            </div>
            <div class="flex-grow-1">
                <div class="fw-bold text-dark">{{ m.producto.nombre | upper }}</div>
                <div class="text-muted small">{{ m.tipo }} por <b>{{ m.usuario }}</b></div>
            </div>
            <div class="text-end">
                <div class="fw-bold {% if m.cantidad > 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ '+' if m.cantidad > 0 }}{{ m.cantidad }} UND
                </div>
                <div class="text-muted" style="font-size: 0.7rem;">{{ m.fecha.strftime('%d/%m - %H:%M') }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 30px;">
            <form action="{{ url_for('inventario.crear_producto') }}" method="POST">
                <div class="modal-header text-white p-4" style="border-radius: 30px 30px 0 0; background-color: #0ea5e9;">
                    <h5 class="modal-title fw-bold">REGISTRAR EN CAVA</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-12"><label class="fw-bold small">CÓDIGO (VACÍO PARA AUTO)</label><input name="codigo" class="form-control" placeholder="Opcional"></div>
                        <div class="col-md-8"><label class="fw-bold small">Nombre</label><input name="nombre" class="form-control" required></div>
                        <div class="col-md-4"><label class="fw-bold small">Marca</label><input name="marca" class="form-control"></div>
                        <div class="col-md-4"><label class="fw-bold small text-primary">Costo</label><input name="valor_interno" id="new_costo" type="number" step="0.01" class="form-control" oninput="actualizarTotales('new')"></div>
                        <div class="col-md-4"><label class="fw-bold small">Margen %</label>
                            <select class="form-select" onchange="aplicarMargen('new', this.value)">
                                <option value="0">-- % --</option>
                                {% for i in range(5, 71, 5) %}<option value="{{ i }}">{{ i }}%</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4"><label class="fw-bold small text-success">Venta</label><input name="valor_venta" id="new_venta" type="number" step="0.01" class="form-control" oninput="actualizarTotales('new')"></div>
                        <div class="col-12"><label class="fw-bold small">Stock</label><input name="cantidad" id="new_cantidad" type="number" class="form-control" value="0" oninput="actualizarTotales('new')"></div>
                        <div class="col-12 mt-3"><div class="bg-ganancia-box"><span class="label-total">Ganancia Unit.</span><div id="new_ganancia" class="h4 fw-bold text-success">$ 0</div></div></div>
                        <div class="col-md-6"><div class="bg-total-box"><span class="label-total">Inversión</span><span id="new_total_costo" class="value-total">$ 0</span></div></div>
                        <div class="col-md-6"><div class="bg-total-box"><span class="label-total">Utilidad</span><span id="new_total_ganancia" class="value-total">$ 0</span></div></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4"><button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-pill" style="background-color: #0ea5e9;">GUARDAR</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 30px;">
            <form method="POST" id="editForm">
                <div class="modal-header bg-dark text-white p-4" style="border-radius: 30px 30px 0 0;">
                    <h5 class="modal-title fw-bold">EDITAR PRODUCTO</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-12"><label class="fw-bold small">CÓDIGO</label><input name="codigo" id="edit_codigo" class="form-control" required></div>
                        <div class="col-md-8"><label class="fw-bold small">Nombre</label><input name="nombre" id="edit_nombre" class="form-control" required></div>
                        <div class="col-md-4"><label class="fw-bold small">Marca</label><input name="marca" id="edit_marca" class="form-control"></div>
                        <div class="col-md-4"><label class="fw-bold small">Costo</label><input name="valor_interno" id="edit_costo" type="number" step="0.01" class="form-control" oninput="actualizarTotales('edit')"></div>
                        <div class="col-md-4"><label class="fw-bold small">Margen %</label>
                            <select class="form-select" onchange="aplicarMargen('edit', this.value)">
                                <option value="0">-- % --</option>
                                {% for i in range(5, 71, 5) %}<option value="{{ i }}">{{ i }}%</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4"><label class="fw-bold small text-success">Venta</label><input name="valor_venta" id="edit_venta" type="number" step="0.01" class="form-control" oninput="actualizarTotales('edit')"></div>
                        <div class="col-12"><label class="fw-bold small">Stock</label><input name="cantidad" id="edit_cantidad" type="number" class="form-control" oninput="actualizarTotales('edit')"></div>
                        <div class="col-12 mt-3"><div class="bg-ganancia-box"><span class="label-total">Ganancia Unit.</span><div id="edit_ganancia" class="h4 fw-bold text-success">$ 0</div></div></div>
                        <div class="col-md-6"><div class="bg-total-box"><span class="label-total">Inversión</span><span id="edit_total_costo" class="value-total">$ 0</span></div></div>
                        <div class="col-md-6"><div class="bg-total-box"><span class="label-total">Utilidad</span><span id="edit_total_ganancia" class="value-total">$ 0</span></div></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4"><button type="submit" class="btn btn-dark w-100 py-3 fw-bold rounded-pill">ACTUALIZAR</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <form action="" method="POST" id="stockForm">
                <div class="modal-header text-white" style="background-color: #2dd4bf; border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title fw-bold">CARGAR BODEGA</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 text-center">
                    <h4 id="stock_nombre_prod" class="fw-bold mb-4" style="color: #0f766e;"></h4>
                    <div class="row g-3">
                        <div class="col-6"><label class="small fw-bold">ACTUAL</label><input type="number" id="stock_actual" class="form-control text-center bg-light border-0" readonly></div>
                        <div class="col-6"><label class="small fw-bold">ENTRADA</label><input type="number" name="cantidad_sumar" id="cantidad_sumar" class="form-control text-center" value="0" oninput="calcularNuevoTotal()"></div>
                        <div class="col-12 mt-4"><div class="p-3 bg-light rounded-3"><small class="fw-bold">STOCK FINAL</small><div id="stock_nuevo_total" class="h1 fw-bold text-primary mb-0">0</div></div></div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4"><button type="submit" class="btn btn-dark w-100 py-3 fw-bold rounded-pill">CONFIRMAR</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="barcodeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-body text-center p-5">
                <div id="area-impresion-barcode">
                    <div class="card-etiqueta-print">
                        <h4 id="tag-nombre" class="fw-bold text-primary"></h4>
                        <p id="tag-marca" class="text-muted small mb-1"></p>
                        <div class="precio-tag" id="tag-precio"></div>
                        <div class="mt-2"><img id="tag-barcode-img" src="" style="max-width: 100%;"><p class="fw-bold mt-1"><code id="tag-codigo-texto"></code></p></div>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button class="btn btn-outline-primary fw-bold" onclick="window.print()">IMPRIMIR</button>
                    <button class="btn btn-secondary fw-bold" data-bs-dismiss="modal">CERRAR</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// BUSCADOR REFORZADO - AHORA CON BOTÓN DE BARRAS FUNCIONAL
document.getElementById('globalSearch').addEventListener('input', function() {
    let query = this.value.trim();
    let tbody = document.getElementById('inventoryBody');

    if (query.length >= 2) {
        fetch(`/api/productos/buscar?q=${query}`)
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = '';
                data.forEach(p => {
                    const stockClass = p.stock > 5 ? 'stock-top' : 'stock-low';
                    const alertRow = p.stock <= 3 ? 'stock-alert-critical' : '';
                    
                    // Escapar nombres para JS
                    const pNombre = p.nombre.replace(/'/g, "\\'");
                    const pMarca = (p.marca || '').replace(/'/g, "\\'");
                    
                    tbody.innerHTML += `
                        <tr class="product-row ${alertRow}">
                            <td><span class="badge bg-light text-primary border fw-bold">${p.codigo || 'AUTO'}</span></td>
                            <td class="text-start">
                                <div class="fw-bold text-dark">${p.nombre}</div>
                                <div class="small text-muted">${p.marca || 'SIN MARCA'}</div>
                            </td>
                            <td><span class="badge-stock ${stockClass}">${p.stock} UND</span></td>
                            <td><span class="fw-bold text-dark fs-5">$${p.precio.toLocaleString()}</span></td>
                            <td>
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn-action-base btn-action-stock" onclick="openStockModal('${p.id}', '${pNombre}', '${p.stock}')"><i class="fas fa-cubes"></i></button>
                                    <button class="btn-action-base btn-action-barcode" onclick="verEtiqueta('${p.codigo}', '${pNombre}', '${pMarca}', '${p.precio}')"><i class="fas fa-barcode"></i></button>
                                    {% if current_user.rol.lower() == 'administrador' %}
                                    <button class="btn-action-base btn-action-edit" onclick="openEditModal('${p.id}', '${pNombre}', '${pMarca}', '${p.codigo}', '${p.valor_interno}', '${p.precio}', '${p.stock}')"><i class="fas fa-edit"></i></button>
                                    <a class="btn-action-base btn-action-delete" href="/inventario/eliminar_producto/${p.id}" onclick="return confirm('¿Eliminar?')"><i class="fas fa-trash-alt"></i></a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>`;
                });
            });
    } else if (query.length === 0) {
        location.reload();
    }
});

function aplicarMargen(prefijo, porcentaje) {
    const costo = parseFloat(document.getElementById(prefijo + '_costo').value) || 0;
    if (porcentaje > 0) {
        document.getElementById(prefijo + '_venta').value = Math.round(costo * (1 + (parseInt(porcentaje) / 100)));
        actualizarTotales(prefijo);
    }
}

function actualizarTotales(prefijo) {
    const costo = parseFloat(document.getElementById(prefijo + '_costo').value) || 0;
    const venta = parseFloat(document.getElementById(prefijo + '_venta').value) || 0;
    const cantidad = parseInt(document.getElementById(prefijo + '_cantidad').value) || 0;
    const gananciaUni = venta - costo;
    document.getElementById(prefijo + '_ganancia').innerText = '$ ' + gananciaUni.toLocaleString();
    document.getElementById(prefijo + '_total_costo').innerText = '$ ' + (costo * cantidad).toLocaleString();
    document.getElementById(prefijo + '_total_ganancia').innerText = '$ ' + (gananciaUni * cantidad).toLocaleString();
}

function openEditModal(id, nombre, marca, codigo, costo, venta, cantidad) {
    document.getElementById('edit_nombre').value = nombre;
    document.getElementById('edit_marca').value = marca;
    document.getElementById('edit_codigo').value = codigo === 'N/A' ? '' : codigo;
    document.getElementById('edit_costo').value = costo;
    document.getElementById('edit_venta').value = venta;
    document.getElementById('edit_cantidad').value = cantidad;
    document.getElementById('editForm').action = "/inventario/editar/" + id;
    actualizarTotales('edit');
    new bootstrap.Modal(document.getElementById('editProductModal')).show();
}

function openStockModal(id, nombre, actual) {
    document.getElementById('stock_nombre_prod').innerText = nombre.toUpperCase();
    document.getElementById('stock_actual').value = actual;
    document.getElementById('cantidad_sumar').value = 0;
    document.getElementById('stock_nuevo_total').innerText = actual;
    document.getElementById('stockForm').action = "/inventario/ajustar_stock/" + id;
    new bootstrap.Modal(document.getElementById('stockModal')).show();
}

function calcularNuevoTotal() {
    const actual = parseInt(document.getElementById('stock_actual').value) || 0;
    const sumar = parseInt(document.getElementById('cantidad_sumar').value) || 0;
    document.getElementById('stock_nuevo_total').innerText = actual + sumar;
}

function verEtiqueta(codigo, nombre, marca, precio) {
    document.getElementById('tag-nombre').innerText = nombre.toUpperCase();
    document.getElementById('tag-marca').innerText = marca || 'SAN ROQUE MB';
    document.getElementById('tag-codigo-texto').innerText = codigo || 'S/N';
    document.getElementById('tag-precio').innerText = '$ ' + parseFloat(precio).toLocaleString();
    document.getElementById('tag-barcode-img').src = `/generar_codigo/${codigo || '0000'}`;
    new bootstrap.Modal(document.getElementById('barcodeModal')).show();
}
</script>
{% endblock %}