{% extends 'base.html' %}
{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    :root { 
        --blue-dark: #1a5276; 
        --blue-primary: #3498db; 
        --blue-soft-bg: #f0f7fc;
        --blue-pastel: #d6eaf8;
        --success-pastel: #d4edda;
        --border-color: #d1dce5;
    }

    body { 
        background-color: #f8fbff; 
        font-family: 'Inter', 'Segoe UI', sans-serif;
        color: #34495e;
    }

    .hero-san-roque { 
        background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%);
        color: white; 
        padding: 2rem; 
        border-radius: 18px; 
        box-shadow: 0 10px 30px rgba(41, 128, 185, 0.15);
        margin-bottom: 2rem;
    }

    .card-pos { 
        border: 1px solid var(--border-color); 
        border-radius: 16px; 
        background: #ffffff;
        box-shadow: 0 4px 15px rgba(0,0,0,0.02);
        padding: 20px;
    }

    .form-control, .form-select {
        border-radius: 10px;
        border: 1.5px solid var(--blue-pastel);
        padding: 10px 15px;
    }

    .btn-action {
        border-radius: 10px;
        padding: 8px 16px;
        font-weight: 600;
        border: 1.5px solid;
        background: transparent;
        font-size: 0.8rem;
    }

    .btn-cobrar-blue { color: #2ecc71; border-color: #2ecc71; }
    .btn-cobrar-blue:hover { background: #2ecc71; color: white; }

    .btn-delete-min {
        border: none;
        background: #fdf2f2;
        color: #e74c3c;
        width: 34px;
        height: 34px;
        border-radius: 10px;
    }

    .comanda-detail {
        font-size: 0.85rem;
        background: var(--blue-soft-bg);
        border-radius: 12px;
        padding: 12px;
        margin-top: 8px;
        border: 1px solid var(--blue-pastel);
    }

    summary { cursor:pointer; color: var(--blue-primary); }

</style>

<div class="container py-4">

<div class="hero-san-roque">
    <h1 class="fw-bold mb-0">SAN ROQUE M.B.</h1>
    <p class="opacity-75">Cuentas Cortas</p>
</div>

<div class="row g-4">

<!-- ================= FORMULARIO ================= -->
<div class="col-lg-4">
<div class="card-pos">

<h5 class="fw-bold text-primary mb-3">
<i class="bi bi-plus-circle-fill"></i> Cargar Pedido
</h5>

<form method="POST">

<input name="cliente" class="form-control mb-3 text-uppercase"
placeholder="CLIENTE / MESA" required>

<input name="producto" id="codigo_barra"
class="form-control mb-2"
placeholder="Escanear cÃ³digo" autofocus>

<input id="producto_nombre_display"
class="form-control mb-2 bg-light"
readonly placeholder="Producto...">

<div class="row g-2 mb-3">
    <div class="col-6">
        <input type="number" name="cantidad"
        value="1" min="1"
        class="form-control text-center">
    </div>
    <div class="col-6">
        <input type="date" name="fecha"
        value="{{ hoy }}"
        class="form-control">
    </div>
</div>

<button class="btn btn-primary w-100">
Agregar
</button>

</form>
</div>
</div>

<!-- ================= TABLA ================= -->
<div class="col-lg-8">
<div class="card-pos p-0">

<table class="table align-middle mb-0">

<thead>
<tr class="text-center">
<th class="text-start">Cliente</th>
<th>Total</th>
<th>Saldo</th>
<th>Acciones</th>
</tr>
</thead>

<tbody>

{% for c in creditos %}
{% set saldo = (c.total_consumido or 0) - (c.abonado or 0) %}

<tr class="text-center">

<td class="text-start">

<b>{{ c.cliente }}</b>

<details>

<summary>Detalle ({{ c.items|length }})</summary>

<div class="comanda-detail">

{% for it in c.items %}

<!-- ITEM -->
<form method="POST"
action="{{ url_for('creditos.editar_item_credito', item_id=it.id) }}">

<div class="row g-1 align-items-center mb-1">

<div class="col-5">
<input name="producto"
value="{{ it.producto }}"
class="form-control form-control-sm">
</div>

<div class="col-2">
<input name="cantidad" type="number"
value="{{ it.cantidad }}"
min="1"
class="form-control form-control-sm text-center">
</div>

<div class="col-3 text-end">
<b>${{ "{:,.0f}".format(it.total_linea) }}</b>
</div>

<div class="col-2 text-end">
<button class="btn btn-sm btn-success">
ðŸ’¾
</button>
</div>

</div>

</form>

{% endfor %}

</div>
</details>

</td>

<td>${{ "{:,.0f}".format(c.total_consumido) }}</td>

<td>
<span class="badge bg-danger">
${{ "{:,.0f}".format(saldo) }}
</span>
</td>

<td>

<button class="btn-action btn-cobrar-blue"
data-bs-toggle="modal"
data-bs-target="#modal{{ c.id }}">
Cobrar
</button>

<form id="del{{ c.id }}" method="POST"
action="{{ url_for('creditos.eliminar_credito', credito_id=c.id) }}"></form>

<button class="btn-delete-min"
onclick="confirmarEliminar({{ c.id }})">
ðŸ—‘
</button>

</td>

</tr>

<!-- MODAL COBRO -->
<div class="modal fade" id="modal{{ c.id }}">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">

<form method="POST"
action="{{ url_for('creditos.registrar_abono') }}">

<input type="hidden" name="credito_id" value="{{ c.id }}">

<div class="modal-body">

<h5>{{ c.cliente }}</h5>

<h2 class="text-danger">
${{ "{:,.0f}".format(saldo) }}
</h2>

<input type="number"
name="monto_abono"
value="{{ saldo }}"
class="form-control mb-2">

<select name="medio_pago"
class="form-select mb-2">
<option>Efectivo</option>
<option>Nequi</option>
<option>Daviplata</option>
<option>Tarjeta</option>
</select>

<input type="date"
name="fecha_pago"
value="{{ hoy }}"
class="form-control">

</div>

<div class="modal-footer">
<button class="btn btn-success w-100">
Finalizar
</button>
</div>

</form>

</div>
</div>
</div>

{% endfor %}

</tbody>
</table>

</div>
</div>

</div>
</div>

<script>

document.getElementById("codigo_barra")
.addEventListener("change", function(){

let codigo = this.value;

fetch(`/creditos/buscar_producto/${codigo}`)
.then(r=>r.json())
.then(data=>{
if(!data.error){
document.getElementById("producto_nombre_display").value = data.nombre;
}else{
alert("Producto no encontrado");
this.value="";
}
});

});

function confirmarEliminar(id){
if(confirm("Â¿Eliminar esta cuenta?")){
document.getElementById("del"+id).submit();
}
}

</script>

{% endblock %}
