{% extends "base.html" %}

{% block title %}GestiÃ³n de Personal â€¢ SAN ROQUE MB{% endblock %}

{% block content %}
{% if current_user.rol.lower() in ['administrador', 'administradora'] %}

<style>
    /* ðŸ¥ƒ IDENTIDAD VISUAL SAN ROQUE MB */
    :root {
        --primary-oxford: #1A365D;
        --accent-sky: #63B3ED;
        --bg-glacial: #F0F7FF;
        --bg-card-blue: #BEE3F8;
        --success-cyan: #00A3C4;
        --danger-red: #C53030;
        --text-dark: #2D3748;
    }

    body { background-color: var(--bg-glacial); font-family: 'Inter', sans-serif; }

    .titulo-seccion {
        font-weight: 800;
        color: var(--primary-oxford);
        text-align: center;
        margin: 35px 0;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    /* CONTENEDOR DE TABLA PREMIUM */
    .tabla-container-sr {
        border-radius: 20px;
        background: #fff;
        border: 1px solid var(--bg-card-blue);
        box-shadow: 0 10px 30px rgba(26, 54, 93, 0.05);
        overflow: hidden;
    }

    .table-sr thead th {
        background: var(--primary-oxford);
        color: white !important;
        font-size: 0.75rem;
        font-weight: 700;
        border: none;
        padding: 20px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .table-sr tbody tr { transition: 0.2s; }
    .table-sr tbody tr:hover { background-color: var(--bg-glacial); }

    /* BOTONES DE ACCIÃ“N */
    .btn-crear-sr {
        background-color: var(--primary-oxford);
        border: none;
        color: white;
        font-weight: 800;
        border-radius: 12px;
        padding: 14px 28px;
        transition: 0.3s;
        text-transform: uppercase;
        font-size: 0.8rem;
        box-shadow: 0 6px 15px rgba(26, 54, 93, 0.2);
    }
    .btn-crear-sr:hover {
        background-color: var(--accent-sky);
        color: white;
        transform: translateY(-2px);
    }

    .btn-edit-sr {
        border: 2px solid var(--primary-oxford);
        color: var(--primary-oxford);
        font-weight: 800;
        border-radius: 10px;
        padding: 8px 16px;
        background: transparent;
        text-decoration: none;
        transition: 0.2s;
        font-size: 0.75rem;
    }
    .btn-edit-sr:hover { background: var(--primary-oxford); color: white; }

    .btn-delete-sr {
        background-color: #fee2e2;
        color: var(--danger-red);
        font-weight: 800;
        border-radius: 10px;
        padding: 8px 16px;
        border: none;
        transition: 0.2s;
        font-size: 0.75rem;
    }
    .btn-delete-sr:hover { background: var(--danger-red); color: white; }

    /* BADGES DE ROL */
    .badge-admin { background: var(--primary-oxford); color: white; border-radius: 8px; font-weight: 800; text-transform: uppercase; font-size: 0.65rem; }
    .badge-vendedor { background: var(--bg-card-blue); color: var(--primary-oxford); border-radius: 8px; font-weight: 800; text-transform: uppercase; font-size: 0.65rem; border: 1px solid var(--accent-sky); }

    /* MODALES CUSTOM */
    .modal-sr { border-radius: 25px; border: none; overflow: hidden; }
    .modal-header-sr { background: var(--primary-oxford); color: white; border-bottom: 5px solid var(--accent-sky); }
</style>

<div class="container py-4">
    <h2 class="titulo-seccion"><i class="fas fa-users-cog me-2"></i> GestiÃ³n de Personal MB</h2>

    <div class="text-end mb-4 px-3">
        <button type="button" class="btn btn-crear-sr" data-bs-toggle="modal" data-bs-target="#agregarUsuarioModal">
            <i class="fas fa-user-plus me-2"></i> ALTA DE PERSONAL
        </button>
    </div>

    <div class="mx-3 mb-5 tabla-container-sr">
        <table class="table table-hover table-sr align-middle text-center mb-0">
            <thead>
                <tr>
                    <th>IDENTIFICADOR</th>
                    <th>NOMBRE COMPLETO</th>
                    <th>NIVEL DE ACCESO</th>
                    <th>OPERACIONES</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr>
                    <td class="fw-bold" style="color: var(--primary-oxford);">{{ usuario.username | upper }}</td>
                    <td class="text-dark fw-semibold">{{ usuario.nombre }} {{ usuario.apellido }}</td>
                    <td>
                        {% if usuario.rol.lower() in ['administrador', 'administradora'] %}
                            <span class="badge badge-admin px-3 py-2">Administrador</span>
                        {% else %}
                            <span class="badge badge-vendedor px-3 py-2">Colaborador / Ventas</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if usuario.id != current_user.id %}
                        <div class="d-flex justify-content-center gap-2">
                            <button type="button" class="btn-edit-sr" 
                                onclick="abrirModalEditar('{{ usuario.id }}', '{{ usuario.nombre }}', '{{ usuario.apellido }}', '{{ usuario.cedula }}', '{{ usuario.rol }}')">
                                <i class="fas fa-cog me-1"></i> GESTIONAR
                            </button>

                            <a href="{{ url_for('admin.eliminar_usuario', usuario_id=usuario.id) }}" 
                               class="btn-delete-sr"
                               onclick="return confirm('Â¿Confirmar baja definitiva del usuario {{ usuario.username }}?')">
                                <i class="fas fa-user-minus me-1"></i> DAR DE BAJA
                            </a>
                        </div>
                        {% else %}
                        <span class="badge bg-light text-muted border px-3 py-2 small fw-bold"><i class="fas fa-user-shield me-1"></i> SESIÃ“N ACTIVA</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="agregarUsuarioModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-sr shadow-lg">
      <form action="{{ url_for('admin.agregar_usuario') }}" method="POST">
        <div class="modal-header modal-header-sr p-4">
          <h5 class="modal-title fw-bold text-uppercase tracking-widest"><i class="fas fa-shield-alt me-2"></i> Registro de Personal</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body p-4 bg-white">
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted uppercase">Username (Acceso)</label>
            <input type="text" class="form-control fw-bold" name="username" placeholder="Ej: lrodriguez" required>
          </div>
          <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label small fw-bold text-muted uppercase">Nombre</label>
                <input type="text" class="form-control" name="nombre" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label small fw-bold text-muted uppercase">Apellido</label>
                <input type="text" class="form-control" name="apellido" required>
              </div>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted uppercase">NÂº de Documento</label>
            <input type="text" class="form-control" name="cedula" required>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted uppercase">Privilegios del Sistema</label>
            <select class="form-select fw-bold" name="rol" required>
              <option value="Administrador">ADMINISTRADOR (ACCESO TOTAL)</option>
              <option value="Vendedor">COLABORADOR / CAJERO</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small fw-bold text-muted uppercase">ContraseÃ±a Temporal</label>
            <input type="password" class="form-control" name="password" required>
          </div>
        </div>

        <div class="modal-footer border-0 bg-light p-4">
          <button type="button" class="btn btn-link text-muted fw-bold text-decoration-none" data-bs-dismiss="modal">CANCELAR</button>
          <button type="submit" class="btn btn-crear-sr px-5">CONFIRMAR ALTA</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-sr shadow-lg">
            <form id="formEditarUsuario" method="POST">
                <div class="modal-header bg-dark text-white p-4">
                    <h5 class="modal-title fw-bold text-uppercase tracking-widest"><i class="fas fa-user-edit me-2"></i> Modificar Perfil</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4 bg-white">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold text-muted uppercase">Nombre</label>
                            <input type="text" class="form-control" name="nombre" id="edit_nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small fw-bold text-muted uppercase">Apellido</label>
                            <input type="text" class="form-control" name="apellido" id="edit_apellido" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">CÃ©dula</label>
                        <input type="text" class="form-control" name="cedula" id="edit_cedula" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Rol de Usuario</label>
                        <select class="form-select fw-bold" name="rol" id="edit_rol" required>
                            <option value="Administrador">ADMINISTRADOR (ACCESO TOTAL)</option>
                            <option value="Vendedor">COLABORADOR / CAJERO</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-muted uppercase">Actualizar ContraseÃ±a</label>
                        <input type="password" class="form-control" name="password" placeholder="DEJAR VACÃO PARA MANTENER ACTUAL">
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light p-4">
                    <button type="button" class="btn btn-link text-muted fw-bold text-decoration-none" data-bs-dismiss="modal">DESCARTAR</button>
                    <button type="submit" class="btn btn-crear-sr px-5">GUARDAR CAMBIOS</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function abrirModalEditar(id, nombre, apellido, cedula, rol) {
    document.getElementById('edit_nombre').value = nombre;
    document.getElementById('edit_apellido').value = apellido;
    document.getElementById('edit_cedula').value = cedula;
    document.getElementById('edit_rol').value = rol;

    // Aseguramos que la ruta apunte al controlador correcto de tu proyecto
    document.getElementById('formEditarUsuario').action = "/usuarios/editar/" + id;

    var editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    editModal.show();
}
</script>

{% else %}
<div class="container text-center mt-5">
    <div class="p-5 bg-white shadow-lg rounded-4 border border-warning" style="max-width: 600px; margin: 0 auto;">
        <i class="fas fa-user-lock fa-4x text-warning mb-4"></i>
        <h3 class="fw-bold text-dark uppercase">Acceso Restringido</h3>
        <p class="text-muted fs-6">Lorena, esta secciÃ³n requiere privilegios de Administrador para ser visualizada.</p>
        <a href="{{ url_for('ventas.dashboard') }}" class="btn btn-crear-sr mt-3">Volver al Dashboard</a>
    </div>
</div>
{% endif %}
{% endblock %}