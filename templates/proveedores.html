{% extends 'base.html' %}

{% block content %}
<style>
    /* Est√©tica Unificada "San Roque M.B." - Francesco Virgolini Edition */
    :root {
        --btn-size: 40px; 
        --san-roque-dark: #1a365d;
        --san-roque-emerald: #059669;
        --san-roque-emerald-light: #10b981;
        --san-roque-sapphire: #2563eb;
        --san-roque-ruby: #dc2626;
    }

    /* Botones de Acci√≥n Sim√©tricos y Elegantes */
    .btn-action-custom {
        width: var(--btn-size);
        height: var(--btn-size);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 0;
        font-size: 1.2rem;
        cursor: pointer;
    }

    /* Efecto Hover General */
    .btn-action-custom:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    /* BOT√ìN ABONAR: Blanco por fuera, Esmeralda al pasar el mouse */
    .btn-abonar-prof {
        background: white;
        color: var(--san-roque-emerald);
        border: 2px solid var(--san-roque-emerald);
    }

    .btn-abonar-prof:hover {
        background: linear-gradient(135deg, var(--san-roque-emerald) 0%, var(--san-roque-emerald-light) 100%);
        color: white;
        border-color: transparent;
    }

    /* BOT√ìN EDITAR: Blanco por fuera, Zafiro al pasar el mouse */
    .btn-edit-prof {
        background: white;
        color: var(--san-roque-sapphire);
        border: 2px solid var(--san-roque-sapphire);
    }
    .btn-edit-prof:hover {
        background: var(--san-roque-sapphire);
        color: white;
    }

    /* BOT√ìN ELIMINAR: Blanco por fuera, Rub√≠ al pasar el mouse */
    .btn-delete-prof {
        background: white;
        color: var(--san-roque-ruby);
        border: 2px solid var(--san-roque-ruby);
    }
    .btn-delete-prof:hover {
        background: var(--san-roque-ruby);
        color: white;
    }

    .card-luxury {
        border-radius: 20px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        background: rgba(255, 255, 255, 0.98);
    }

    .table-luxury thead {
        background: var(--san-roque-dark);
        color: white;
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
</style>

<div class="container-fluid mt-4 px-4" style="background-color: #f4f7f9; min-height: 100vh; font-family: 'Poppins', sans-serif;">
    
    <div class="fondo-particulas"></div>

    <div class="row mb-4" style="position: relative; z-index: 1;">
        <div class="col-12">
            <div class="p-4 card-luxury d-flex justify-content-between align-items-center"
                 style="border-left: 8px solid var(--san-roque-dark);">
                <div>
                    <h2 style="color:var(--san-roque-dark);font-weight:800;margin:0;">üì¶ Control de Proveedores</h2>
                    <p class="text-muted mb-0 fw-medium">San Roque M.B. ‚Äî Francesco Virgolini Edition üèéÔ∏è</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('ventas.dashboard') }}" class="btn btn-outline-secondary fw-bold rounded-pill px-4">Dashboard</a>
                    <a href="{{ url_for('proveedores_gastos.gastos') }}" class="btn btn-outline-primary fw-bold rounded-pill px-4">Gastos</a>
                    <a href="{{ url_for('proveedores_gastos.exportar_proveedores') }}" class="btn btn-success fw-bold rounded-pill px-4 shadow-sm">Exportar</a>
                </div>
            </div>
        </div>
    </div>

    <div class="row" style="position: relative; z-index: 1;">

        <div class="col-lg-4 mb-4">
            <div class="card p-4 card-luxury shadow-lg border-0">
                <h5 class="fw-bold mb-4 text-primary">üìë Radicar Factura</h5>
                <form method="POST" action="{{ url_for('proveedores_gastos.enlista_proveedores') }}">
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">N√öMERO FACTURA</label>
                        <input type="text" name="numero" class="form-control rounded-3 border-light bg-light" required>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">PROVEEDOR</label>
                        <input type="text" name="proveedor" class="form-control rounded-3 border-light bg-light" required>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">TOTAL DEUDA</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-light fw-bold text-primary">$</span>
                            <input type="number" step="0.01" name="total" class="form-control rounded-end-3 border-light bg-light" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">FECHA RECEPCI√ìN</label>
                        <input type="date" name="fecha" class="form-control rounded-3 border-light bg-light">
                    </div>
                    <button class="btn btn-primary w-100 fw-bold rounded-pill py-2 shadow">üíæ GUARDAR FACTURA</button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card card-luxury shadow-lg overflow-hidden border-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0 table-luxury">
                        <thead>
                            <tr>
                                <th class="ps-4 py-3 text-white">FECHA</th>
                                <th class="py-3 text-white">FACTURA</th>
                                <th class="py-3 text-white">PROVEEDOR</th>
                                <th class="py-3 text-white">TOTAL</th>
                                <th class="py-3 text-white">SALDO</th>
                                <th class="text-center py-3 text-white">GESTI√ìN</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                        {% for f in facturas %}
                            {% set saldo = f.total - f.abonado %}
                            <tr>
                                <td class="ps-4 text-muted small">{{ f.fecha_factura }}</td>
                                <td><span class="badge rounded-pill bg-dark px-3">{{ f.numero }}</span></td>
                                <td class="fw-bold text-secondary">{{ f.proveedor }}</td>
                                <td class="fw-bold">${{ "{:,.0f}".format(f.total) }}</td>
                                <td>
                                    {% if saldo <= 0 %}
                                        <span class="badge bg-success bg-opacity-10 text-success fw-bold px-3 py-2" style="border-radius:10px;">PAGADA ‚úÖ</span>
                                    {% else %}
                                        <span class="fw-bold text-danger" style="font-size: 1.1rem;">${{ "{:,.0f}".format(saldo) }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn-action-custom btn-abonar-prof" 
                                                data-bs-toggle="collapse" data-bs-target="#abono{{ f.id }}" title="Registrar Pago">
                                            üí≥
                                        </button>
                                        <button class="btn-action-custom btn-edit-prof" 
                                                data-bs-toggle="modal" data-bs-target="#editFactura{{ f.id }}" title="Editar Datos">
                                            ‚úèÔ∏è
                                        </button>
                                        <form method="POST" action="{{ url_for('proveedores_gastos.eliminar_factura', factura_id=f.id) }}">
                                            <button class="btn-action-custom btn-delete-prof" 
                                                    onclick="return confirm('¬øEliminar factura permanentemente?')" title="Eliminar Registro">
                                                üóëÔ∏è
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>

                            <tr class="collapse" id="abono{{ f.id }}">
                                <td colspan="6" class="p-0 border-0">
                                    <div class="p-4 mx-4 mb-3 rounded-4 shadow-inner" style="background: #f8fafc; border: 1px solid #e2e8f0;">
                                        <div class="row">
                                            <div class="col-md-7 border-end border-2">
                                                <h6 class="fw-bold text-primary mb-3 text-uppercase small">Historial de Pagos</h6>
                                                <div class="pe-2">
                                                    {% set tiene_abonos = false %}
                                                    {% for a in abonos if a.factura_id == f.id %}
                                                        {% set tiene_abonos = true %}
                                                        <div class="d-flex justify-content-between align-items-center p-3 mb-2 bg-white rounded-3 shadow-sm border-start border-4 border-success">
                                                            <div>
                                                                <span class="text-muted small">üìÖ {{ a.fecha }}</span><br>
                                                                <strong class="text-dark" style="font-size: 1.1rem;">${{ "{:,.0f}".format(a.monto) }}</strong>
                                                            </div>
                                                            <a href="{{ url_for('proveedores_gastos.eliminar_abono_proveedor', abono_id=a.id) }}" 
                                                               class="text-danger p-0" onclick="return confirm('¬øEliminar este abono?')">
                                                                <span style="font-size: 1.2rem;">üóëÔ∏è</span>
                                                            </a>
                                                        </div>
                                                    {% endfor %}
                                                    {% if not tiene_abonos %}
                                                        <p class="text-muted small italic">Sin movimientos registrados.</p>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="col-md-5 ps-4">
                                                <h6 class="fw-bold text-success mb-3 text-uppercase small">Nuevo Abono</h6>
                                                {% if saldo > 0 %}
                                                    <form method="POST" action="{{ url_for('proveedores_gastos.abonar', factura_id=f.id) }}">
                                                        <input type="number" step="0.01" name="monto" placeholder="Monto $" class="form-control mb-2 border-0 shadow-sm" required>
                                                        <select name="medio" class="form-select mb-2 border-0 shadow-sm">
                                                            <option>Efectivo</option>
                                                            <option>Transferencia</option>
                                                            <option>Nequi</option>
                                                        </select>
                                                        <button class="btn btn-abonar-prof w-100 rounded-pill py-2 shadow-sm fw-bold">PROCESAR PAGO</button>
                                                    </form>
                                                {% else %}
                                                    <div class="alert alert-success py-2 text-center fw-bold rounded-4">CUENTA SALDADA</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% for f in facturas %}
<div class="modal fade" id="editFactura{{ f.id }}" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST" action="{{ url_for('proveedores_gastos.editar_factura', factura_id=f.id) }}" class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <div class="modal-header p-4 border-0" style="background: var(--san-roque-dark); color: white; border-radius: 25px 25px 0 0;">
                <h5 class="modal-title fw-bold">‚úèÔ∏è Actualizar Registro</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="small fw-bold text-muted">PROVEEDOR</label>
                    <input type="text" name="proveedor" value="{{ f.proveedor }}" class="form-control bg-light border-0" required>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-muted">N¬∞ FACTURA</label>
                    <input type="text" name="numero" value="{{ f.numero }}" class="form-control bg-light border-0" required>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-muted">VALOR TOTAL</label>
                    <input type="number" step="0.01" name="total" value="{{ f.total }}" class="form-control bg-light border-0" required>
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-muted">FECHA</label>
                    <input type="date" name="fecha" value="{{ f.fecha_factura }}" class="form-control bg-light border-0">
                </div>
            </div>
            <div class="modal-footer p-4 border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">CANCELAR</button>
                <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold shadow">GUARDAR CAMBIOS</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% endblock %}